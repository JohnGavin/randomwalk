# Workflow derived from https://github.com/ropensci/rix/tree/main/.github/workflows
# and https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  release:
    types: [published]
  workflow_dispatch:

name: pkgdown

permissions:
  contents: read
  deployments: write

jobs:
  pkgdown:
    runs-on: ubuntu-latest
    # Only restrict concurrency for non-PR jobs
    concurrency:
      group: pkgdown-${{ github.event_name != 'pull_request' || github.run_id }}
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create nix folder to silence warning
        run: mkdir -p ~/.nix-defexpr/channels

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=https://github.com/rstats-on-nix/nixpkgs/archive/refs/heads/r-daily.tar.gz

      - uses: cachix/cachix-action@v15
        with:
          name: johngavin
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Run build script
        run: |
          nix-shell default-ci.nix --quiet --pure --run "Rscript -e '
            # Build pkgdown site
            # Note: pkgdown can build without loading the package in pure nix shell

            # Clean any existing site first
            if (dir.exists(\"docs\")) {
              pkgdown::clean_site(force = TRUE)
            }

            # Build pkgdown site (skip article building for now)
            pkgdown::build_reference()
            pkgdown::build_home()
            pkgdown::build_articles_index()
          '"

      - name: Download WebAssembly library from latest release
        if: github.event_name != 'pull_request'
        run: |
          # Create directory for wasm files
          mkdir -p docs/wasm

          # Download library.data and library.js.metadata from latest release
          # These files will be served from the same origin as the dashboard
          # avoiding CORS issues
          gh release download --repo JohnGavin/randomwalk \
            --pattern "library.data" \
            --pattern "library.js.metadata" \
            --dir docs/wasm
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Export sync dashboard with R shinylive
        run: |
          nix-shell default-ci.nix --quiet --pure --run "Rscript -e '
            # Clean destination directory to avoid cached/stale files
            if (dir.exists(\"docs/articles/dashboard\")) {
              unlink(\"docs/articles/dashboard\", recursive = TRUE)
            }

            # Export Shiny app to Shinylive format using R package
            # This creates docs/articles/dashboard/ with all shinylive assets
            shinylive::export(
              appdir = \"inst/shiny/dashboard\",
              destdir = \"docs/articles/dashboard\"
            )

            # Don'\''t copy index.html - keep dashboard in its own folder
            # Users will access it at /articles/dashboard/ not /articles/dashboard.html
            # This ensures relative paths to ./shinylive/ work correctly
          '"

      - name: Export async dashboard with R shinylive
        run: |
          nix-shell default-ci.nix --quiet --pure --run "Rscript -e '
            # Clean destination directory
            if (dir.exists(\"docs/articles/dashboard_async\")) {
              unlink(\"docs/articles/dashboard_async\", recursive = TRUE)
            }

            # Export async Shiny app to Shinylive format
            shinylive::export(
              appdir = \"inst/shiny/dashboard_async\",
              destdir = \"docs/articles/dashboard_async\"
            )
          '"

      - name: Deploy to GitHub pages
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4.4.1
        with:
          clean: false
          branch: gh-pages
          folder: docs
