<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>v2.0.0 Async Implementation Plan • randomwalk</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="v2.0.0 Async Implementation Plan"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">randomwalk</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/dashboard.html">Interactive Dashboard</a></li>
    <li><a class="dropdown-item" href="articles/telemetry.html">Telemetry and Pipeline Statistics</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>v2.0.0 Async Implementation Plan</h1>

    </div>

<div id="v200-async-implementation-plan" class="section level1">

<p><strong>Status</strong>: Tracked in GitHub Issues <strong>GitHub Issue</strong>: <a href="https://github.com/JohnGavin/randomwalk/issues/20" class="external-link">#20 - v2.0.0: Implement Async/Parallel Simulation Framework</a> <strong>Target</strong>: Implement true async/parallel random walk simulation <strong>Approach</strong>: Simplified architecture without DuckDB</p>
<div class="section level2">
<h2 id="implementation-tracking">Implementation Tracking<a class="anchor" aria-label="anchor" href="#implementation-tracking"></a></h2>
<p>This plan is now tracked in GitHub issues: - <strong>Main Issue</strong>: <a href="https://github.com/JohnGavin/randomwalk/issues/20" class="external-link">#20</a> - v2.0.0 Async Framework - <strong>Phase 1</strong>: <a href="https://github.com/JohnGavin/randomwalk/issues/21" class="external-link">#21</a> - Minimal Async Implementation - <strong>Phase 2</strong>: <a href="https://github.com/JohnGavin/randomwalk/issues/22" class="external-link">#22</a> - State Synchronization - <strong>Phase 3</strong>: <a href="https://github.com/JohnGavin/randomwalk/issues/23" class="external-link">#23</a> - Optimization - <strong>Phase 4</strong>: <a href="https://github.com/JohnGavin/randomwalk/issues/24" class="external-link">#24</a> - Testing &amp; Documentation</p>
<p><strong>Note</strong>: Phases are logical organization, not time estimates. Implementation proceeds as tasks are completed.</p>
<p><strong>This document serves as the detailed technical reference for the implementation.</strong></p>
</div>
<div class="section level2">
<h2 id="decision-simplified-architecture">Decision: Simplified Architecture<a class="anchor" aria-label="anchor" href="#decision-simplified-architecture"></a></h2>
<p>After analysis, we’ve decided to implement async mode <strong>without DuckDB</strong> for v2.0.0.</p>
<div class="section level3">
<h3 id="original-plan-duckdb--nanonext">Original Plan (DuckDB + nanonext)<a class="anchor" aria-label="anchor" href="#original-plan-duckdb--nanonext"></a></h3>
<ul><li>❌ DuckDB for persistent state</li>
<li>✅ nanonext for communication</li>
<li>✅ crew for worker management</li>
<li>
<strong>Complexity</strong>: High</li>
<li>
<strong>Dependencies</strong>: 3 new packages</li>
</ul></div>
<div class="section level3">
<h3 id="revised-plan-nanonext--r-environment">Revised Plan (nanonext + R environment)<a class="anchor" aria-label="anchor" href="#revised-plan-nanonext--r-environment"></a></h3>
<ul><li>✅ R environment for in-memory state</li>
<li>✅ nanonext for pub/sub communication</li>
<li>✅ crew for worker management</li>
<li>
<strong>Complexity</strong>: Medium</li>
<li>
<strong>Dependencies</strong>: 2 new packages</li>
</ul></div>
<div class="section level3">
<h3 id="rationale">Rationale<a class="anchor" aria-label="anchor" href="#rationale"></a></h3>
<p>DuckDB adds complexity without clear benefit for this use case: - Grid state fits easily in memory (20×20 = 400 values) - No need for SQL queries or transactions - Random walks don’t require persistence - Simpler = easier to debug and maintain</p>
<p><strong>DuckDB consideration</strong>: Can revisit for v3.0.0 if needed for very large grids (1000×1000+) or complex spatial queries.</p>
</div>
</div>
<div class="section level2">
<h2 id="architecture-components">Architecture Components<a class="anchor" aria-label="anchor" href="#architecture-components"></a></h2>
<div class="section level3">
<h3 id="id_1-shared-state-r-environment">1. Shared State (R Environment)<a class="anchor" aria-label="anchor" href="#id_1-shared-state-r-environment"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Global environment shared across main process</span></span>
<span><span class="va">grid_state_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">grid_state_env</span><span class="op">$</span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">grid_size</span>, ncol <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span></span>
<span><span class="va">grid_state_env</span><span class="op">$</span><span class="va">black_pixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Fast lookup</span></span>
<span><span class="va">grid_state_env</span><span class="op">$</span><span class="va">version</span> <span class="op">&lt;-</span> <span class="fl">0L</span>  <span class="co"># Increment on each update</span></span></code></pre></div>
<p><strong>Benefits</strong>: - Fast in-memory access - No serialization overhead - Native R data structures - Easy to inspect/debug</p>
</div>
<div class="section level3">
<h3 id="id_2-communication-nanonext">2. Communication (nanonext)<a class="anchor" aria-label="anchor" href="#id_2-communication-nanonext"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Publisher socket (main process)</span></span>
<span><span class="va">pub_socket</span> <span class="op">&lt;-</span> <span class="fu">nano_socket</span><span class="op">(</span><span class="st">"pub"</span>, listen <span class="op">=</span> <span class="st">"tcp://127.0.0.1:5555"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Worker subscribes</span></span>
<span><span class="va">sub_socket</span> <span class="op">&lt;-</span> <span class="fu">nano_socket</span><span class="op">(</span><span class="st">"sub"</span>, dial <span class="op">=</span> <span class="st">"tcp://127.0.0.1:5555"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Broadcast update</span></span>
<span><span class="fu">nano_send</span><span class="op">(</span><span class="va">pub_socket</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"pixel_update"</span>,</span>
<span>  position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  version <span class="op">=</span> <span class="va">grid_state_env</span><span class="op">$</span><span class="va">version</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Worker receives</span></span>
<span><span class="va">update</span> <span class="op">&lt;-</span> <span class="fu">nano_recv</span><span class="op">(</span><span class="va">sub_socket</span>, mode <span class="op">=</span> <span class="st">"raw"</span>, block <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><strong>Communication Patterns</strong>: - <strong>Pub/Sub</strong>: State updates broadcast to all workers - <strong>Push/Pull</strong>: Job queue for walker assignment - <strong>Req/Rep</strong>: Worker status queries (optional)</p>
</div>
<div class="section level3">
<h3 id="id_3-worker-management-crew">3. Worker Management (crew)<a class="anchor" aria-label="anchor" href="#id_3-worker-management-crew"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wlandau.github.io/crew/" class="external-link">crew</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create worker pool</span></span>
<span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">crew_controller_local</span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"random_walk_workers"</span>,</span>
<span>  workers <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  seconds_idle <span class="op">=</span> <span class="fl">300</span>  <span class="co"># Keep alive for 5 minutes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Start workers</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Push walker jobs</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">walker_id</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_walkers</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">controller</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span></span>
<span>    command <span class="op">=</span> <span class="fu">step_walker_async</span><span class="op">(</span><span class="va">walker_id</span>, <span class="va">grid_state_env</span><span class="op">$</span><span class="va">version</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      walker_id <span class="op">=</span> <span class="va">walker_id</span>,</span>
<span>      neighborhood <span class="op">=</span> <span class="va">neighborhood</span>,</span>
<span>      boundary <span class="op">=</span> <span class="va">boundary</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Collect results</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Worker Lifecycle</strong>: 1. Controller spawns R process 2. Worker initializes local cache 3. Worker pulls job from queue 4. Worker executes walker steps 5. Worker reports results 6. Worker pulls next job or waits 7. Controller terminates idle workers</p>
</div>
</div>
<div class="section level2">
<h2 id="implementation-phases">Implementation Phases<a class="anchor" aria-label="anchor" href="#implementation-phases"></a></h2>
<div class="section level3">
<h3 id="phase-1-minimal-async-1-2-weeks">Phase 1: Minimal Async (1-2 weeks)<a class="anchor" aria-label="anchor" href="#phase-1-minimal-async-1-2-weeks"></a></h3>
<p><strong>Goal</strong>: Get basic parallel execution working</p>
<p><strong>Tasks</strong>: - [ ] Add crew to Imports in DESCRIPTION - [ ] Add nanonext to Imports in DESCRIPTION - [ ] Create <code>R/async_controller.R</code>: - <code>create_controller()</code> - Initialize crew controller - <code>create_pub_socket()</code> - Set up nanonext publisher - <code>cleanup_async()</code> - Shutdown workers and sockets - [ ] Create <code>R/async_worker.R</code>: - <code>worker_init()</code> - Initialize worker with sub socket - <code>worker_step_walker()</code> - Execute walker step - <code>worker_check_updates()</code> - Check for grid updates - [ ] Modify <code>R/simulation.R</code>: - Add <code>if (workers &gt; 0)</code> branch for async mode - Keep existing sync code for <code>workers = 0</code> - [ ] Add tests in <code>tests/testthat/test-async.R</code>: - Test controller startup/shutdown - Test job distribution - Test basic 2-worker simulation</p>
<p><strong>Deliverable</strong>: Basic parallel execution (no optimization)</p>
<p><strong>Expected Speedup</strong>: 1.5-1.8x with 2 workers</p>
</div>
<div class="section level3">
<h3 id="phase-2-state-synchronization-1-week">Phase 2: State Synchronization (1 week)<a class="anchor" aria-label="anchor" href="#phase-2-state-synchronization-1-week"></a></h3>
<p><strong>Goal</strong>: Implement efficient grid state updates</p>
<p><strong>Tasks</strong>: - [ ] Create <code>R/grid_state.R</code>: - <code>create_grid_env()</code> - Initialize shared environment - <code>update_pixel()</code> - Mark pixel black, increment version - <code>broadcast_update()</code> - Send via nanonext - <code>get_black_neighbors()</code> - Fast neighbor lookup - [ ] Implement worker cache: - <code>worker_cache$black_pixels</code> - Local copy - <code>worker_cache$version</code> - Track state version - <code>refresh_cache()</code> - Pull updates when version mismatch - [ ] Add cache invalidation: - Workers check version before each step - Refresh only if outdated - Batch multiple updates</p>
<p><strong>Deliverable</strong>: Workers stay synchronized with &lt;10ms lag</p>
<p><strong>Expected Speedup</strong>: 1.7-2.0x with 2 workers, 2.5-3.0x with 4 workers</p>
</div>
<div class="section level3">
<h3 id="phase-3-optimization-1-2-weeks">Phase 3: Optimization (1-2 weeks)<a class="anchor" aria-label="anchor" href="#phase-3-optimization-1-2-weeks"></a></h3>
<p><strong>Goal</strong>: Minimize synchronization overhead</p>
<p><strong>Tasks</strong>: - [ ] Implement batched updates: - Accumulate multiple pixel changes - Broadcast every N updates or T seconds - Trade freshness for reduced overhead - [ ] Add spatial partitioning: - Assign walkers to workers by grid region - Minimize contention on same pixels - Reduce cross-worker interference - [ ] Non-blocking communication: - Use <code>block = FALSE</code> in nano_recv - Workers continue with stale state if no update - Periodic sync rather than every step - [ ] Benchmark and tune: - Measure sync overhead vs computation time - Optimize batch sizes - Find optimal update frequency</p>
<p><strong>Deliverable</strong>: Near-linear speedup for 2-4 workers</p>
<p><strong>Expected Speedup</strong>: 1.8-2.0x with 2 workers, 3.0-3.5x with 4 workers, 4.0-5.0x with 8 workers</p>
</div>
<div class="section level3">
<h3 id="phase-4-testing--documentation-1-week">Phase 4: Testing &amp; Documentation (1 week)<a class="anchor" aria-label="anchor" href="#phase-4-testing--documentation-1-week"></a></h3>
<p><strong>Goal</strong>: Production-ready async mode</p>
<p><strong>Tasks</strong>: - [ ] Comprehensive test suite: - Test 1, 2, 4, 8, 16 workers - Test with different grid sizes - Test boundary conditions - Test worker failures/restarts - [ ] Performance benchmarks: - Compare sync vs async modes - Measure speedup across configurations - Identify bottlenecks - [ ] Documentation: - Update README with async usage - Add vignette on parallel performance - Document when to use sync vs async - [ ] Update Shinylive dashboard: - Add worker count slider (disabled in browser) - Show async mode status - Display worker statistics</p>
<p><strong>Deliverable</strong>: v2.0.0 release with async mode</p>
</div>
</div>
<div class="section level2">
<h2 id="implementation-details">Implementation Details<a class="anchor" aria-label="anchor" href="#implementation-details"></a></h2>
<div class="section level3">
<h3 id="shared-grid-state">Shared Grid State<a class="anchor" aria-label="anchor" href="#shared-grid-state"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># R/grid_state.R</span></span>
<span></span>
<span><span class="co">#' Create Shared Grid Environment</span></span>
<span><span class="va">create_grid_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">grid_size</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">env</span><span class="op">$</span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">grid_size</span>, ncol <span class="op">=</span> <span class="va">grid_size</span><span class="op">)</span></span>
<span>  <span class="va">env</span><span class="op">$</span><span class="va">grid</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">grid_size</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">grid_size</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>  <span class="co"># Center black</span></span>
<span>  <span class="va">env</span><span class="op">$</span><span class="va">black_pixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">grid_size</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">grid_size</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">env</span><span class="op">$</span><span class="va">version</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>  <span class="va">env</span><span class="op">$</span><span class="va">lock</span> <span class="op">&lt;-</span> <span class="fu">mutex</span><span class="op">(</span><span class="op">)</span>  <span class="co"># For thread safety</span></span>
<span>  <span class="va">env</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Update Pixel (Thread-safe)</span></span>
<span><span class="va">update_pixel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">grid_env</span>, <span class="va">pos</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">lock</span><span class="op">(</span><span class="va">grid_env</span><span class="op">$</span><span class="va">lock</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">unlock</span><span class="op">(</span><span class="va">grid_env</span><span class="op">$</span><span class="va">lock</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">grid_env</span><span class="op">$</span><span class="va">grid</span><span class="op">[</span><span class="va">pos</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">pos</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">grid_env</span><span class="op">$</span><span class="va">grid</span><span class="op">[</span><span class="va">pos</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">pos</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">grid_env</span><span class="op">$</span><span class="va">black_pixels</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">grid_env</span><span class="op">$</span><span class="va">black_pixels</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pos</span></span>
<span>    <span class="va">grid_env</span><span class="op">$</span><span class="va">version</span> <span class="op">&lt;-</span> <span class="va">grid_env</span><span class="op">$</span><span class="va">version</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># Update made</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already black</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Get Black Neighbors (Fast Lookup)</span></span>
<span><span class="va">get_black_neighbors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">grid_env</span>, <span class="va">pos</span>, <span class="va">neighborhood</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">offsets</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">neighborhood</span> <span class="op">==</span> <span class="st">"4-hood"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Check each neighbor against black_pixels list</span></span>
<span>  <span class="va">neighbors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">offsets</span>, <span class="kw">function</span><span class="op">(</span><span class="va">off</span><span class="op">)</span> <span class="va">pos</span> <span class="op">+</span> <span class="va">off</span><span class="op">)</span></span>
<span>  <span class="va">black</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">neighbors</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">grid_env</span><span class="op">$</span><span class="va">black_pixels</span>, <span class="kw">function</span><span class="op">(</span><span class="va">bp</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">bp</span> <span class="op">==</span> <span class="va">n</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">neighbors</span><span class="op">[</span><span class="va">black</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="worker-communication">Worker Communication<a class="anchor" aria-label="anchor" href="#worker-communication"></a></h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># R/async_worker.R</span></span>
<span></span>
<span><span class="co">#' Initialize Worker</span></span>
<span><span class="va">worker_init</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sub_socket_url</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Subscribe to updates</span></span>
<span>  <span class="va">sub_socket</span> <span class="op">&lt;-</span> <span class="fu">nano_socket</span><span class="op">(</span><span class="st">"sub"</span>, dial <span class="op">=</span> <span class="va">sub_socket_url</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Initialize local cache</span></span>
<span>  <span class="va">cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">cache</span><span class="op">$</span><span class="va">black_pixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">cache</span><span class="op">$</span><span class="va">version</span> <span class="op">&lt;-</span> <span class="fl">0L</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>socket <span class="op">=</span> <span class="va">sub_socket</span>, cache <span class="op">=</span> <span class="va">cache</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Check for Grid Updates</span></span>
<span><span class="va">worker_check_updates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">worker</span>, <span class="va">grid_env</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Non-blocking check for messages</span></span>
<span>  <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu">nano_recv</span><span class="op">(</span><span class="va">worker</span><span class="op">$</span><span class="va">socket</span>, mode <span class="op">=</span> <span class="st">"raw"</span>, block <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">update</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">unserialize</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">update</span><span class="op">$</span><span class="va">version</span> <span class="op">&gt;</span> <span class="va">worker</span><span class="op">$</span><span class="va">cache</span><span class="op">$</span><span class="va">version</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Newer state available, refresh cache</span></span>
<span>      <span class="va">worker</span><span class="op">$</span><span class="va">cache</span><span class="op">$</span><span class="va">black_pixels</span> <span class="op">&lt;-</span> <span class="va">grid_env</span><span class="op">$</span><span class="va">black_pixels</span></span>
<span>      <span class="va">worker</span><span class="op">$</span><span class="va">cache</span><span class="op">$</span><span class="va">version</span> <span class="op">&lt;-</span> <span class="va">grid_env</span><span class="op">$</span><span class="va">version</span></span>
<span>      <span class="fu">logger</span><span class="fu">::</span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_level.html" class="external-link">log_debug</a></span><span class="op">(</span><span class="st">"Worker cache updated to version {update$version}"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">worker</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Worker Step Function</span></span>
<span><span class="va">worker_step_walker</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">walker</span>, <span class="va">neighborhood</span>, <span class="va">boundary</span>,</span>
<span>                                <span class="va">grid_env</span>, <span class="va">worker</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Check for updates before step</span></span>
<span>  <span class="va">worker</span> <span class="op">&lt;-</span> <span class="fu">worker_check_updates</span><span class="op">(</span><span class="va">worker</span>, <span class="va">grid_env</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Move walker</span></span>
<span>  <span class="va">walker</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/step_walker.html">step_walker</a></span><span class="op">(</span><span class="va">walker</span>, <span class="va">neighborhood</span>, <span class="va">boundary</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Check termination (using cached black pixels)</span></span>
<span>  <span class="va">has_black_neighbor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span></span>
<span>    <span class="fu">get_black_neighbors</span><span class="op">(</span><span class="va">grid_env</span>, <span class="va">walker</span><span class="op">$</span><span class="va">pos</span>, <span class="va">neighborhood</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">has_black_neighbor</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">walker</span><span class="op">$</span><span class="va">active</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>    <span class="va">walker</span><span class="op">$</span><span class="va">termination_reason</span> <span class="op">&lt;-</span> <span class="st">"touched_black_neighbor"</span></span>
<span></span>
<span>    <span class="co"># Update global state</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu">update_pixel</span><span class="op">(</span><span class="va">grid_env</span>, <span class="va">walker</span><span class="op">$</span><span class="va">pos</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Broadcast update</span></span>
<span>      <span class="fu">broadcast_update</span><span class="op">(</span><span class="va">pub_socket</span>, <span class="va">walker</span><span class="op">$</span><span class="va">pos</span>, <span class="va">grid_env</span><span class="op">$</span><span class="va">version</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">walker</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="broadcast-mechanism">Broadcast Mechanism<a class="anchor" aria-label="anchor" href="#broadcast-mechanism"></a></h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># R/async_controller.R</span></span>
<span></span>
<span><span class="co">#' Create Publisher Socket</span></span>
<span><span class="va">create_pub_socket</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">port</span> <span class="op">=</span> <span class="fl">5555</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"tcp://127.0.0.1:%d"</span>, <span class="va">port</span><span class="op">)</span></span>
<span>  <span class="fu">nano_socket</span><span class="op">(</span><span class="st">"pub"</span>, listen <span class="op">=</span> <span class="va">url</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Broadcast State Update</span></span>
<span><span class="va">broadcast_update</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pub_socket</span>, <span class="va">pos</span>, <span class="va">version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"pixel_update"</span>,</span>
<span>    position <span class="op">=</span> <span class="va">pos</span>,</span>
<span>    version <span class="op">=</span> <span class="va">version</span>,</span>
<span>    timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">nano_send</span><span class="op">(</span><span class="va">pub_socket</span>, <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize</a></span><span class="op">(</span><span class="va">msg</span>, <span class="cn">NULL</span><span class="op">)</span>, mode <span class="op">=</span> <span class="st">"raw"</span><span class="op">)</span></span>
<span>  <span class="fu">logger</span><span class="fu">::</span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_level.html" class="external-link">log_trace</a></span><span class="op">(</span><span class="st">"Broadcasted update: v{version} at ({pos[1]},{pos[2]})"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a></h2>
<div class="section level3">
<h3 id="run_simulation-parameters">run_simulation() Parameters<a class="anchor" aria-label="anchor" href="#run_simulation-parameters"></a></h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>run_simulation <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="at">grid_size =</span> <span class="dv">10</span>,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="at">n_walkers =</span> <span class="dv">5</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="at">neighborhood =</span> <span class="st">"4-hood"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="at">boundary =</span> <span class="st">"terminate"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="at">workers =</span> <span class="dv">0</span>,           <span class="co"># 0 = sync, 1+ = async</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="at">max_steps =</span> <span class="dv">10000</span><span class="dt">L</span>,</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  <span class="at">update_batch =</span> <span class="dv">1</span>,      <span class="co"># Batch N updates before broadcast</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  <span class="at">update_interval =</span> <span class="fl">0.1</span>, <span class="co"># Or broadcast every T seconds</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="recommended-settings">Recommended Settings<a class="anchor" aria-label="anchor" href="#recommended-settings"></a></h3>
<p><strong>Small grids (≤50×50), few walkers (≤10)</strong>: - <code>workers = 0</code> (sync mode) - Overhead exceeds benefit</p>
<p><strong>Medium grids (50-200), many walkers (10-50)</strong>: - <code>workers = 2-4</code> (async mode) - <code>update_batch = 5-10</code> - <code>update_interval = 0.05</code></p>
<p><strong>Large grids (200+), many walkers (50+)</strong>: - <code>workers = 4-8</code> (async mode) - <code>update_batch = 20-50</code> - <code>update_interval = 0.1</code></p>
</div>
</div>
<div class="section level2">
<h2 id="testing-strategy">Testing Strategy<a class="anchor" aria-label="anchor" href="#testing-strategy"></a></h2>
<div class="section level3">
<h3 id="unit-tests">Unit Tests<a class="anchor" aria-label="anchor" href="#unit-tests"></a></h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tests/testthat/test-async.R</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"controller starts and stops"</span>, <span class="op">{</span></span>
<span>  <span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu">create_controller</span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="va">controller</span><span class="op">$</span><span class="va">started</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">cleanup_async</span><span class="op">(</span><span class="va">controller</span><span class="op">)</span></span>
<span>  <span class="fu">expect_false</span><span class="op">(</span><span class="va">controller</span><span class="op">$</span><span class="va">started</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"workers receive broadcasts"</span>, <span class="op">{</span></span>
<span>  <span class="va">grid_env</span> <span class="op">&lt;-</span> <span class="fu">create_grid_env</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">pub_socket</span> <span class="op">&lt;-</span> <span class="fu">create_pub_socket</span><span class="op">(</span><span class="fl">5555</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Simulate worker</span></span>
<span>  <span class="va">worker</span> <span class="op">&lt;-</span> <span class="fu">worker_init</span><span class="op">(</span><span class="st">"tcp://127.0.0.1:5555"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Broadcast update</span></span>
<span>  <span class="fu">broadcast_update</span><span class="op">(</span><span class="va">pub_socket</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>  <span class="co"># Allow time for message</span></span>
<span></span>
<span>  <span class="co"># Worker should receive</span></span>
<span>  <span class="va">worker</span> <span class="op">&lt;-</span> <span class="fu">worker_check_updates</span><span class="op">(</span><span class="va">worker</span>, <span class="va">grid_env</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">worker</span><span class="op">$</span><span class="va">cache</span><span class="op">$</span><span class="va">version</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="integration-tests">Integration Tests<a class="anchor" aria-label="anchor" href="#integration-tests"></a></h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"async simulation produces correct results"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Run same simulation in sync and async</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">sync_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/run_simulation.html">run_simulation</a></span><span class="op">(</span></span>
<span>    grid_size <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    n_walkers <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    workers <span class="op">=</span> <span class="fl">0</span>  <span class="co"># Sync</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">async_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/run_simulation.html">run_simulation</a></span><span class="op">(</span></span>
<span>    grid_size <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    n_walkers <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    workers <span class="op">=</span> <span class="fl">2</span>  <span class="co"># Async</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Results should be similar (not identical due to async timing)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">sync_result</span><span class="op">$</span><span class="va">statistics</span><span class="op">$</span><span class="va">total_walkers</span>,</span>
<span>               <span class="va">async_result</span><span class="op">$</span><span class="va">statistics</span><span class="op">$</span><span class="va">total_walkers</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Black pixel counts should be close (within 10%)</span></span>
<span>  <span class="fu">expect_lt</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">sync_result</span><span class="op">$</span><span class="va">statistics</span><span class="op">$</span><span class="va">black_pixels</span> <span class="op">-</span></span>
<span>        <span class="va">async_result</span><span class="op">$</span><span class="va">statistics</span><span class="op">$</span><span class="va">black_pixels</span><span class="op">)</span>,</span>
<span>    <span class="va">sync_result</span><span class="op">$</span><span class="va">statistics</span><span class="op">$</span><span class="va">black_pixels</span> <span class="op">*</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="performance-benchmarks">Performance Benchmarks<a class="anchor" aria-label="anchor" href="#performance-benchmarks"></a></h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># benchmarks/benchmark_async.R</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bench.r-lib.org/" class="external-link">bench</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span></span>
<span>  sync <span class="op">=</span> <span class="fu"><a href="reference/run_simulation.html">run_simulation</a></span><span class="op">(</span>grid_size <span class="op">=</span> <span class="fl">100</span>, n_walkers <span class="op">=</span> <span class="fl">20</span>, workers <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  async_2 <span class="op">=</span> <span class="fu"><a href="reference/run_simulation.html">run_simulation</a></span><span class="op">(</span>grid_size <span class="op">=</span> <span class="fl">100</span>, n_walkers <span class="op">=</span> <span class="fl">20</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  async_4 <span class="op">=</span> <span class="fu"><a href="reference/run_simulation.html">run_simulation</a></span><span class="op">(</span>grid_size <span class="op">=</span> <span class="fl">100</span>, n_walkers <span class="op">=</span> <span class="fl">20</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  async_8 <span class="op">=</span> <span class="fu"><a href="reference/run_simulation.html">run_simulation</a></span><span class="op">(</span>grid_size <span class="op">=</span> <span class="fl">100</span>, n_walkers <span class="op">=</span> <span class="fl">20</span>, workers <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate speedups</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">speedup</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">median</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">results</span><span class="op">$</span><span class="va">median</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">results</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"median"</span>, <span class="st">"speedup"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="migration-path">Migration Path<a class="anchor" aria-label="anchor" href="#migration-path"></a></h2>
<div class="section level3">
<h3 id="v100--v200">v1.0.0 → v2.0.0<a class="anchor" aria-label="anchor" href="#v100--v200"></a></h3>
<p><strong>Breaking Changes</strong>: None (async is opt-in via <code>workers</code> parameter)</p>
<p><strong>New Features</strong>: - Async mode with crew + nanonext - Performance benchmarks - Worker statistics</p>
<p><strong>Deprecated</strong>: Nothing</p>
<p><strong>Removed</strong>: Nothing</p>
<p><strong>User Impact</strong>: Zero for existing code (default <code>workers = 0</code> is sync)</p>
</div>
</div>
<div class="section level2">
<h2 id="success-criteria">Success Criteria<a class="anchor" aria-label="anchor" href="#success-criteria"></a></h2>
<div class="section level3">
<h3 id="functional-requirements">Functional Requirements<a class="anchor" aria-label="anchor" href="#functional-requirements"></a></h3>
<ul><li>✅ Async mode produces valid random walks</li>
<li>✅ Workers synchronize within 10ms</li>
<li>✅ No race conditions or deadlocks</li>
<li>✅ Graceful handling of worker failures</li>
<li>✅ Clean shutdown releases all resources</li>
</ul></div>
<div class="section level3">
<h3 id="performance-requirements">Performance Requirements<a class="anchor" aria-label="anchor" href="#performance-requirements"></a></h3>
<ul><li>✅ 2 workers: 1.5-2.0x speedup</li>
<li>✅ 4 workers: 2.5-3.5x speedup</li>
<li>✅ 8 workers: 3.5-5.0x speedup</li>
<li>✅ Sync overhead &lt; 15% of total time</li>
</ul></div>
<div class="section level3">
<h3 id="code-quality-requirements">Code Quality Requirements<a class="anchor" aria-label="anchor" href="#code-quality-requirements"></a></h3>
<ul><li>✅ Test coverage &gt; 80%</li>
<li>✅ No R CMD check warnings</li>
<li>✅ Documentation complete</li>
<li>✅ Vignette with examples</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="implementation-phases-1">Implementation Phases<a class="anchor" aria-label="anchor" href="#implementation-phases-1"></a></h2>
<table class="table"><thead><tr class="header"><th>Phase</th>
<th>Deliverable</th>
</tr></thead><tbody><tr class="odd"><td>Phase 1</td>
<td>Basic async (1.5x speedup)</td>
</tr><tr class="even"><td>Phase 2</td>
<td>State sync (2.5x speedup)</td>
</tr><tr class="odd"><td>Phase 3</td>
<td>Optimization (4x speedup)</td>
</tr><tr class="even"><td>Phase 4</td>
<td>Testing &amp; docs</td>
</tr><tr class="odd"><td><strong>Complete</strong></td>
<td><strong>v2.0.0 release</strong></td>
</tr></tbody></table></div>
<div class="section level2">
<h2 id="future-considerations-v300">Future Considerations (v3.0.0+)<a class="anchor" aria-label="anchor" href="#future-considerations-v300"></a></h2>
<div class="section level3">
<h3 id="when-duckdb-makes-sense">When DuckDB Makes Sense<a class="anchor" aria-label="anchor" href="#when-duckdb-makes-sense"></a></h3>
<p>Consider adding DuckDB if: - Grid size &gt; 1000×1000 (1M+ pixels) - Need SQL queries on grid state - Want persistent checkpoints - Complex spatial analytics required</p>
</div>
<div class="section level3">
<h3 id="other-enhancements">Other Enhancements<a class="anchor" aria-label="anchor" href="#other-enhancements"></a></h3>
<ul><li>GPU acceleration for large grids (OpenCL/CUDA)</li>
<li>Distributed workers across multiple machines (ZMQ)</li>
<li>Real-time 3D visualization (rgl/threejs)</li>
<li>Alternative termination conditions (custom rules)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
<ul><li>
<strong>crew</strong>: <a href="https://wlandau.github.io/crew/" class="external-link uri">https://wlandau.github.io/crew/</a>
</li>
<li>
<strong>nanonext</strong>: <a href="https://shikokuchuo.net/nanonext/" class="external-link uri">https://shikokuchuo.net/nanonext/</a>
</li>
<li>
<strong>Amdahl’s Law</strong>: <a href="https://en.wikipedia.org/wiki/Amdahl%27s_law" class="external-link uri">https://en.wikipedia.org/wiki/Amdahl%27s_law</a>
</li>
<li>
<strong>ZMQ Patterns</strong>: <a href="https://zguide.zeromq.org/docs/chapter2/" class="external-link uri">https://zguide.zeromq.org/docs/chapter2/</a>
</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Gavin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

